import streamlit as st
from data.validator import validar_usuario
from data.loader import cargar_datos

# Importar vistas
from views.ranking_docentes_modulos import mostrar_ranking_por_plantel
import views.no_competentes as vista_nc
import views.comportamiento as vista_com
import views.modulos_criticos as vista_mc
import views.mostrar_estatal as vista_estatal
import views.bitacora_conexiones as vista_bc

st.set_page_config(page_title="Tablero Docente", layout="wide")

st.markdown("""
    <style>
    /* Oculta solo los √≠conos individuales dentro del toolbar */
    [data-testid="stToolbar"] > div:nth-child(n+2) {
        display: none !important;
    }
    </style>
""", unsafe_allow_html=True)

# ----------------------------
# Inicializar sesi√≥n
# ----------------------------
if "logueado" not in st.session_state:
    st.session_state.update({
        "logueado": False,
        "plantel_usuario": None,
        "administrador": False
    })

# ----------------------------
# Login con imagen 
# ----------------------------
if not st.session_state.logueado:
    col1, col2 = st.columns([1, 2])

    with col1:
        st.title("üîê Inicio de sesi√≥n")
        usuario = st.text_input("Usuario")
        contrasena = st.text_input("Contrase√±a", type="password")

        if st.button("Iniciar sesi√≥n"):
            ok, plantel, es_admin = validar_usuario(usuario, contrasena)
            if ok:
                st.session_state.update({
                    "logueado": True,
                    "plantel_usuario": plantel,
                    "administrador": es_admin
                })
                st.success("‚úÖ ¬°Sesi√≥n iniciada!")
                st.rerun()
            else:
                st.error("‚ùå Autenticaci√≥n Incorrecta")

    with col2:
        try:
            st.image("utils/ImagenDashDocentes.png", use_container_width=True)
        except Exception:
            st.warning("‚ö†Ô∏è IMAGEN NO DISPONIBLE.")

    st.stop()

# ----------------------------
# Cierre de sesi√≥n
# ----------------------------
st.sidebar.success("‚úÖ Sesi√≥n activa")
st.sidebar.info(f"üë§ {'Administrador' if st.session_state.administrador else f'Plantel: {st.session_state.plantel_usuario}'})")

if st.sidebar.button("Cerrar sesi√≥n"):
    for key in ["logueado", "plantel_usuario", "administrador"]:
        st.session_state.pop(key, None)
    st.rerun()

# ----------------------------
# Cargar datos
# ----------------------------
df, error = cargar_datos()
if error:
    st.error(f"‚ùå Error,no se pueden cargar los datos: {error}")
    st.stop()

# ----------------------------
# Men√∫ desplegable
# ----------------------------
if st.session_state.administrador:
    opciones = [
        "Docentes y M√≥dulos",
        "Docentes Seguimiento",
        "M√≥dulos Seguimiento",
        "Estatal Docentes y M√≥dulos",
        "Bit√°cora de Conexiones"
    ]
else:
    opciones = [
        "Docentes y M√≥dulos",
        "Docentes Seguimiento",
        "M√≥dulos Seguimiento",
        "Ranking por docentes y m√≥dulos"
    ]

opcion = st.sidebar.selectbox("Men√∫ Principal", opciones)

# ----------------------------
# VISTAS DISPONIBLES
# ----------------------------
if opcion == "Docentes y M√≥dulos":
    vista_nc.mostrar(df, st.session_state.plantel_usuario, st.session_state.administrador)

elif opcion == "Estatal Docentes y M√≥dulos" and st.session_state.administrador:
    vista_estatal.mostrar_estatal(df)

elif opcion == "Docentes Seguimiento":
    vista_com.mostrar(df, st.session_state.plantel_usuario, st.session_state.administrador)

elif opcion == "M√≥dulos Seguimiento":
    vista_mc.mostrar(df, st.session_state.plantel_usuario, st.session_state.administrador)

elif opcion == "Bit√°cora de Conexiones" and st.session_state.administrador:
    vista_bc.mostrar()

elif opcion == "Ranking por docentes y m√≥dulos":
    mostrar_ranking_por_plantel(df, st.session_state.plantel_usuario)
